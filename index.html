<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta charset="UTF-8">
        <title>gallery</title>
        <link rel="stylesheet" href="reset.css"/>
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <div class="head">
            <span>Hello</span>
        </div>
        <div class="container" ></div>

        <script src="jquery-1.11.0.min.js"></script>
        <script type="application/javascript">
            var parse_url = function (url) {
                return /^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.test(url);
            }
            /*var IsValidImageUrl = function (url) {
                var img = img || new Image();
                img.src = url;
                console.dir(img.width);
                //alert(img.height != 0);
            }*
            */

            var elementId = 0;

            function insertContacts(contact, position, that) {
                /*name = $('<div>')
                        .text(contact.name)
                        age = $('<div>')
                                .text(contact.age)
                        */


                var colors = {
                    1:'#70afcc',
                    2:'#66a1bd',
                    3:'#5790ab',
                    4:'#4d8199'
                    },
                    defaultInfo = {
                        "title": "title",
                        "time":  "time",
                        "img": "default.png"
                    },
                    number = $('.container'),
                    level = Math.floor((number[0].childNodes.length + 3)/3),
                    record = $('<div>')
                            .addClass('record')
                           /* .append(
                                    $('<span>').text(elementId),
                                    $('<span>').text((contact.title)? contact.title: defaultInfo.title),
                                    $('<span>').text((contact.time)? contact.time: defaultInfo.time)
                            ),*/
                    img = $('<img>', {
                                src: contact.img,
                                class: 'pic',
                                alt: contact.name
                            }),
                    imgDiv = $('<div>').append(img).addClass('imgDiv'),
                    content = $('<div>')
                                .attr('id', elementId)
                                .addClass('content')
                                .css('background-color', (level < 5)? colors[level]: colors[4])
                                .append(record, imgDiv)
                                .dblclick(function () {

                                    var input = $('<div>')
                                            .addClass('form-group');
                                    var button = input.clone()
                                                    .append( $('<button>')
                                                        .addClass('form-control')
                                                        .attr('type', 'submit')
                                                        .text('add')
                                            );
                                    console.log(button);
                                    input.append($('<label>')
                                                    .addClass('control-label'),
                                                $('<input>')
                                                    .addClass('form-control')
                                                    .attr('type', 'text'));
                                    var fieldset = $('<fieldset>')
                                            .append(input.clone()
                                                        .find('label')
                                                            .text('Name')
                                                            .end()
                                                        .find('input')
                                                            .attr('placeholder', 'Time'),
                                                    input.clone()
                                                        .find('label')
                                                            .text('Name')
                                                            .end()
                                                        .find('input')
                                                            .attr('placeholder', 'Time'),
                                                    input.clone()
                                                        .find('label')
                                                            .text('Name')
                                                            .end()
                                                        .find('input')
                                                            .attr('placeholder', 'Time'),
                                                    button
                                            );
                                    var form = $('<form>')
                                            .submit(function (e){
                                                var info = {};
                                                e.preventDefault();
                                                info['name'] = e.target[1].value;
                                                info['age'] = e.target[2].value;
                                                info['img'] = e.target[3].value;
                                                if(info.img === '' || info.name === '' || !parse_url(info.img) || !typeof info.name === 'string' || isNaN(parseInt(info.age))) {
                                                    alert('incorrect');
                                                    return false;
                                                }
                                                $('input').val('');
                                                insertContacts(info);
                                            }).append(fieldset);

                                    var edit = $('<div>')
                                            .addClass('inputs')
                                            .append(form);
                                $(this).append(edit);
                                })
                                .mouseenter( function () {
                                    var icons = $('<div>')
                                                .addClass('hoverDiv')
                                                .append($('<div>')
                                                    .mousedown(function () {
                                                        insertContacts(defaultInfo, 'before', this);
                                                    }), $('<div>')
                                                    .mousedown(function () {
                                                        this.parentNode.parentNode.remove();
                                                    }), $('<div>')
                                                    .mousedown(function () {
                                                        insertContacts(defaultInfo, 'after', this);
                                                    }));
                                    $(this).append(icons);
                            } ).mouseleave( function () {
                                $(this).find('.hoverDiv').remove();
                            });
                if(position && that){
                    if(position === 'before'){
                        $(content).insertBefore( $('#' + that.parentNode.parentNode.id ) );
                    }else if(position === 'after') {
                        $('#' + that.parentNode.parentNode.id ).after( $(content) );
                    }
                } else {
                    //console.log(content);
                    number.append(content);
                }
                elementId += 1;
            }

            $.ajax({
                url: "local.json",
                success: function (data) {
                    var contacts = data.contacts;
                    for (var contact in contacts){
                        if(contacts.hasOwnProperty(contact)){
                            contacts[contact].img = 'img/' + contacts[contact].img;
                            insertContacts(contacts[contact]);
                        }
                    }
                }
            });






/*
            $(document).ready(function() {
                var $dragging = null,
                        offset_x,
                        offset_y,
                        parent,
                        pagePointerX,
                        pagePointerY;

                $(document.body).on("mousemove", function(e) {
                    if ($dragging) {
                        $dragging.offset({
                            top: e.pageY - offset_y,
                            left: e.pageX - offset_x
                        });
                    }
                });
                $(document.body).on("mousedown", ".content", function (e) {
                    $(document.body).css('cursor', 'move');
                    $dragging = $(e.target);
                    $dragging.find('.hoverDiv').remove();
                    offset_x = e.offsetX;
                    offset_y = e.offsetY;
                    pagePointerX = e.pageX;
                    pagePointerY = e.pageY;
                    parent = e.target.parentNode.childNodes;
                });
                $(document.body).on("mouseup", function (e) {
                    var parent2 = e.target.parentNode.childNodes,
                        element,
                    differenceX = pagePointerX - e.pageX,
                    differenceY = pagePointerY - e.pageY;

                    //console.log(differenceX + ' ' + differenceY);
                    //console.log(e);
                    //console.log(parent2);
                    //console.log(e.pageX, e.pageY);
                    $(document.body).css('cursor', 'default');

                    for(element in parent){
                        var t = element.offsetX + element.offsetWidth;
                    }


                    $dragging.css('position', 'static');

                    $dragging = null;
                });
            });*/
            /*$(".container").hover(function(){
             //var id = $(this).attr("id");
             $( $dragging ).insertBefore( this );
             });*/

        </script>
    </body>
</html>
