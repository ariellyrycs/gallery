<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta charset="UTF-8">
        <title>gallery</title>
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <div class="head">
            <span>Hello</span>
        </div>
        <div class="container" ></div>
        <div class="inputs">
            <form id="add-contact">
                <fieldset>
                    <div class="form-group">
                        <label class="control-label">Name</label>
                        <input class="form-control" type="text" placeholder="Name">
                    </div>
                    <div class="form-group">
                        <label class="control-label" >Age</label>
                        <input class="form-control" type="text" placeholder="Age">
                    </div>
                    <div class="form-group">
                        <label class="control-label">Image Url</label>
                        <input class="form-control" type="text" placeholder="Image Url"/>
                    </div>
                    <div class="form-group">
                        <button class="form-control" type="submit" >Add</button>
                    </div>

                </fieldset>
            </form>
        </div>
        <script src="jquery-1.11.0.min.js"></script>
        <script type="application/javascript">
            var parse_url = function (url) {
                return /^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.test(url);
            }
            /*var IsValidImageUrl = function (url) {
                var img = img || new Image();
                img.src = url;
                console.dir(img.width);
                //alert(img.height != 0);
            }*/

            function insertContacts(contact) {

                var colors = {
                    1:'#70afcc',
                    2:'#66a1bd',
                    3:'#5790ab',
                    4:'#4d8199'
                    },
                    number = $('.container');
                    level = Math.floor((number[0].childNodes.length + 3)/3);
                    img = $('<img>', {
                                src: contact.img,
                                class: 'pic center',
                                draggable: 'false',
                                alt: contact.name
                            }),
                    name = $('<div>')
                                .text(contact.name)
                                .addClass('center'),
                    age = $('<div>')
                                .text(contact.age)
                                .addClass('center'),
                    close = $('<img>')
                                .attr('src', 'close.png')
                                .addClass('close-img')
                                .mousedown(function () {
                        this.parentNode.remove();
                    }),
                    content = $('<div>')
                                .addClass('content')
                                .css('background-color', (level < 5)? colors[level]: colors[4])
                                .append(close, img, name, age);
                number.append(content);
            }

            $("#add-contact").submit(function(e){
                var info = {};
                e.preventDefault();
                info['name'] = e.target[1].value;
                info['age'] = e.target[2].value;
                info['img'] = e.target[3].value;
                if(info.img === '' || info.name === '' || !parse_url(info.img) || !typeof info.name === 'string' || isNaN(parseInt(info.age))) {
                    alert('incorrect');
                    return false;
                }
                $('input').val('');
                insertContacts(info);
            });
            $.ajax({
                url: "local.json",
                success: function (data) {
                    var contacts = data.contacts;
                    for (var contact in contacts){
                        if(contacts.hasOwnProperty(contact)){
                            contacts[contact].img = 'img/' + contacts[contact].img;
                            console.log(contact);
                            insertContacts(contacts[contact]);
                        }
                    }
                }
            });




            $(document).ready(function() {
                var $dragging = null,
                        offset_x,
                        offset_y,
                        page_x,
                        page_y;
                $(document.body).on("mousemove", function(e) {
                    if ($dragging) {
                        $dragging.offset({
                            top: e.pageY - offset_y,
                            left: e.pageX - offset_x
                        });
                    }
                });
                $(document.body).on("mousedown", ".content", function (e) {
                    $dragging = $(e.target);
                    offset_x = e.offsetX;
                    offset_y = e.offsetY;
                    page_x = e.pageX;
                    page_y = e.pageY;
                    $(document.body).css('cursor', 'move');
                    console.log(e);
                });
                $(document.body).on("mouseup", function (e) {
                    $(document.body).css('cursor', 'default');
                    $dragging = null;
                });
            });

        </script>
    </body>
</html>
