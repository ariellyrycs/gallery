<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta charset="UTF-8">
        <title>gallery</title>
        <link rel="stylesheet" href="reset.css"/>
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <div class="head">
            <div>
                <h1>My Playlist - {<label id="no">#</label> of songs} songs</h1>
            </div>
        </div>
        <div class="container" ></div>

        <script src="jquery-1.11.0.min.js"></script>
        <script type="application/javascript">
            var parse_url = function (url) {
                return /^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.test(url);
            }
            var refreshAttr = function () {
                var elements = $('.container')[0].childNodes,
                    lengthItem = elements.length + 3,
                    i,
                    level,
                    colors = {
                        1:'#70afcc',
                        2:'#66a1bd',
                        3:'#5790ab',
                        4:'#4d8199'
                    };
                for(i = 0; i < lengthItem; i += 1) {
                    level = (i < 14 )? Math.floor((i + 3)/3): 4;
                    $(elements[i]).css('background-color', colors[level]);
                    $(elements[i]).find('.songNumber').html(i + 1);
                }
                $('#no').html(lengthItem - 3);
            }
            /*var IsValidImageUrl = function (url) {
                var img = img || new Image();
                img.src = url;
                console.dir(img.width);
                //alert(img.height != 0);
            }*
            */

            var elementId = 0;
            function insertContacts(contact, position, that) {


                var defaultInfo = {
                        "title": "{title}",
                        "time":  "{time}",
                        "img": "default.png"
                    },
                    number = $('.container'),
                    recordText = $('<div>').append($('<h2>').html('<label class="songNumber">' + (elementId + 1) + '</label>. <label class="songTitle">' + contact.title +
                            '</label> - <label class="songTime">' + contact.time  + '</label>'
                    )),
                    record = $('<div>')
                            .addClass('record')
                            .append(recordText),
                    img = $('<img>', {
                                src: contact.img,
                                class: 'pic',
                                alt: contact.name
                            }),
                    imgDiv = $('<div>')
                                .append(img)
                                .addClass('imgDiv'),
                    displayInfo = $('<div>')
                                .addClass('contentInfo')
                                .append(record, imgDiv),
                    content = $('<div>')
                                .attr('id', elementId)
                                .addClass('content')
                                .append(displayInfo)
                                .dblclick(function () {
                                    if($(this).find('.contentInfo').length !== 1){
                                        return;
                                    }
                                    var close = $('<img>', {
                                            src: 'cerrar.png',
                                            class : 'close',
                                            alt : 'close'
                                        }).click(function (e) {
                                            $(e.target.parentNode.nextSibling).css('display', 'block');
                                            this.parentNode.remove();
                                        }),
                                        input = $('<div>')
                                                .addClass('form-group'),
                                        button = input.clone()
                                                    .append( $('<button>')
                                                        .addClass('form-control')
                                                        .attr('type', 'submit')
                                                        .text('add')
                                                );
                                    input.append($('<input>')
                                                    .addClass('form-control')
                                                    .attr('type', 'text')
                                                );
                                    var fieldset = $('<fieldset>')
                                            .append(input.clone()
                                                        .find('input')
                                                            .attr('placeholder', 'Title')
                                                            .attr('type', 'text')
                                                            .end(),
                                                    input.clone()
                                                        .find('input')
                                                            .attr('placeholder', 'Time')
                                                            .end(),
                                                    input.clone()
                                                        .find('input')
                                                            .attr('placeholder', 'Image Url')
                                                            .attr('type', 'url')
                                                            .end(),
                                                    button
                                            );
                                    var form = $('<form>')
                                                .submit(function (e) {
                                                    var info = {};
                                                    e.preventDefault();
                                                    info['name'] = e.target[1].value;
                                                    info['time'] = e.target[2].value;
                                                    info['img'] = e.target[3].value;
                                                    if(info.img === '' || info.name === '' || !parse_url(info.img) || !typeof info.name === 'string' || isNaN(parseInt(info.time))) {
                                                        alert('incorrect');
                                                        return false;
                                                    }
                                                    $(e.target.parentNode.nextSibling)
                                                            .find('.songTitle')
                                                                .html(info['name'])
                                                                .end()
                                                            .find('.songTime')
                                                                .html(info['time'])
                                                                .end()
                                                            .find('.pic')
                                                                .attr('src', info['img']);
                                                    $(e.target.parentNode.nextSibling).css('display', 'block');
                                                    $(e.currentTarget.parentNode).remove();

                                                }).append(fieldset);

                                    var edit = $('<div>')
                                                .addClass('contentInfo')
                                                .append(close, form);
                                    $(this).find('.contentInfo').css('display','none');
                                    $(this).prepend(edit);
                                })
                                .mouseenter( function () {
                                    if($(this.parentNode).find('.hoverDiv').length) {
                                        return;
                                    }
                                    var icons = $('<div>')
                                                .addClass('hoverDiv')
                                                .append($('<div>')
                                                    .mousedown(function () {
                                                        insertContacts(defaultInfo, 'before', this);
                                                    }), $('<div>')
                                                    .mousedown(function () {
                                                        this.parentNode.parentNode.remove();
                                                        refreshAttr();
                                                    }), $('<div>')
                                                    .mousedown(function () {
                                                        insertContacts(defaultInfo, 'after', this);
                                                    }));
                                    $(this).append(icons);

                            } ).mouseleave( function () {
                                $(this).find('.hoverDiv').remove();
                            });
                if(position && that){
                    if(position === 'before'){
                        $(content).insertBefore($('#' + that.parentNode.parentNode.id));
                    }else if(position === 'after') {
                        $('#' + that.parentNode.parentNode.id ).after( $(content) );
                    }
                } else {
                    number.append(content);
                }
                elementId += 1;
                refreshAttr();
            }

            $.ajax({
                url: "local.json",
                success: function (data) {
                    var contacts = data.contacts;
                    for (var contact in contacts){
                        if(contacts.hasOwnProperty(contact)){
                            contacts[contact].img = 'img/' + contacts[contact].img;
                            insertContacts(contacts[contact]);
                        }
                    }
                }
            });






            /*/*
            $(document).ready(function() {
                var $dragging = null,
                        offset_x,
                        offset_y,
                        parent,
                        pagePointerX,
                        pagePointerY;

                $(document.body).on("mousemove", function(e) {
                    if ($dragging) {
                        $dragging.offset({
                            top: e.pageY - offset_y,
                            left: e.pageX - offset_x
                        });
                    }
                });
                $(document.body).on("mousedown", ".content", function (e) {
                    $(document.body).css('cursor', 'move');
                    $dragging = $(e.target);
                    $dragging.find('.hoverDiv').remove();
                    offset_x = e.offsetX;
                    offset_y = e.offsetY;
                    pagePointerX = e.pageX;
                    pagePointerY = e.pageY;
                    parent = e.target.parentNode.childNodes;
                });
                $(document.body).on("mouseup", function (e) {
                    var parent2 = e.target.parentNode.childNodes,
                        element,
                    differenceX = pagePointerX - e.pageX,
                    differenceY = pagePointerY - e.pageY;

                    //console.log(differenceX + ' ' + differenceY);
                    //console.log(e);
                    //console.log(parent2);
                    //console.log(e.pageX, e.pageY);
                    $(document.body).css('cursor', 'default');

                    for(element in parent){
                        var t = element.offsetX + element.offsetWidth;
                    }


                    $dragging.css('position', 'static');

                    $dragging = null;
                });
            });
            /*$(".container").hover(function(){
             //var id = $(this).attr("id");
             $( $dragging ).insertBefore( this );
             });*/

        </script>
    </body>
</html>
